<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Selfmade Labs</title>

    <!-- Theme CSS -->
    <link rel="stylesheet" href="/ui/css/theme.css">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons+Round" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <span class="material-icons-round">terminal</span>
                Selfmade Labs
            </div>

            <nav class="sidebar-nav">
                <a href="/ui/dashboard.html" class="nav-item active">
                    <span class="material-icons-round">dashboard</span>
                    <span>Dashboard</span>
                </a>
                <a href="/ui/services.html" class="nav-item">
                    <span class="material-icons-round">dns</span>
                    <span>Services</span>
                </a>
                <a href="/ui/profile.html" class="nav-item">
                    <span class="material-icons-round">person</span>
                    <span>Profile</span>
                </a>
                <a href="/ui/settings.html" class="nav-item">
                    <span class="material-icons-round">settings</span>
                    <span>Settings</span>
                </a>
                <div id="adminNav" style="display: none;">
                    <a href="/ui/admin.html" class="nav-item" style="color: var(--error);">
                        <span class="material-icons-round">admin_panel_settings</span>
                        <span>Admin Panel</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="btn btn-ghost" onclick="api.logout()" style="width: 100%; justify-content: flex-start;">
                    <span class="material-icons-round">logout</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                    <h1 style="margin: 0; font-size: 20px; font-weight: 500;">Dashboard</h1>
                </div>

                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="btn btn-icon btn-ghost" onclick="toggleTheme()" title="Toggle theme">
                        <span class="material-icons-round">brightness_auto</span>
                    </button>

                    <!-- Notifications -->
                    <div style="position: relative;">
                        <button id="notificationBtn" class="btn btn-icon btn-ghost" onclick="toggleNotifications()" title="Notifications">
                            <span class="material-icons-round">notifications</span>
                            <span id="notificationBadge" class="badge badge-error" style="position: absolute; top: 8px; right: 8px; display: none; min-width: 16px; height: 16px; padding: 2px 4px; font-size: 10px;"></span>
                        </button>

                        <!-- Notifications Dropdown -->
                        <div id="notificationsDropdown" class="dropdown" style="display: none;">
                            <div style="padding: var(--spacing-md); border-bottom: 1px solid var(--border-secondary); display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 16px; font-weight: 500;">Notifications</h3>
                                <button class="btn btn-ghost" style="padding: 4px 8px; font-size: 12px;" onclick="markAllRead()">Mark all read</button>
                            </div>
                            <div id="notificationsList" style="max-height: 400px; overflow-y: auto;">
                                <!-- Notifications will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div style="display: flex; align-items: center; gap: var(--spacing-sm); padding-left: var(--spacing-sm); border-left: 1px solid var(--border-primary);">
                        <img id="userAvatar" src="" alt="User" style="width: 32px; height: 32px; border-radius: 50%; display: none;">
                        <div id="userAvatarFallback" style="width: 32px; height: 32px; border-radius: 50%; background: var(--accent-primary); display: flex; align-items: center; justify-content: center; color: var(--text-inverse); font-weight: 500; font-size: 14px;"></div>
                        <div>
                            <div id="userName" style="font-size: 14px; font-weight: 500; color: var(--text-primary);"></div>
                            <div id="userEmail" style="font-size: 12px; color: var(--text-secondary);"></div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div class="content">
                <!-- User Stats -->
                <div class="card-grid" id="statsGrid" style="margin-bottom: var(--spacing-xl);">
                    <!-- Stats cards will be loaded here -->
                </div>

                <!-- Running Labs -->
                <div id="runningLabsSection" style="margin-bottom: var(--spacing-xl); display: none;">
                    <h2 style="font-size: 18px; font-weight: 500; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                        <span class="material-icons-round" style="color: var(--success);">play_circle</span>
                        Running Labs
                    </h2>
                    <div class="card-grid" id="runningLabsGrid">
                        <!-- Running labs will be loaded here -->
                    </div>
                </div>

                <!-- Lab Catalog -->
                <div style="margin-bottom: var(--spacing-xl);">
                    <h2 style="font-size: 18px; font-weight: 500; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                        <span class="material-icons-round">science</span>
                        Lab Catalog
                    </h2>
                    <div class="card-grid" id="catalogGrid">
                        <!-- Lab catalog will be loaded here -->
                    </div>
                </div>

                <!-- Running Services Preview -->
                <div id="runningServicesSection" style="margin-bottom: var(--spacing-xl); display: none;">
                    <h2 style="font-size: 18px; font-weight: 500; margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-sm);">
                        <span class="material-icons-round" style="color: var(--success);">dns</span>
                        Running Services
                        <a href="/ui/services.html" style="margin-left: auto; font-size: 14px; color: var(--accent-primary); text-decoration: none;">View all →</a>
                    </h2>
                    <div class="card-grid" id="runningServicesGrid">
                        <!-- Running services will be loaded here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Theme & API Scripts -->
    <script src="/ui/js/theme.js"></script>
    <script src="/ui/js/api.js"></script>

    <script>
        // Extract token from URL (OAuth callback)
        extractTokenFromURL();

        // Auth Check
        if (!requireAuth()) {
            throw new Error('Not authenticated');
        }

        // Global State
        let currentUser = null;
        let notificationsOpen = false;

        // Initialize Dashboard
        async function initDashboard() {
            try {
                // Load user profile
                currentUser = await api.getProfile();
                renderUserInfo(currentUser);

                // Show admin nav if admin
                if (currentUser.role === 'admin') {
                    document.getElementById('adminNav').style.display = 'block';
                }

                // Load all data in parallel
                await Promise.all([
                    loadStats(),
                    loadLabStatus(),
                    loadLabCatalog(),
                    loadServiceStatus(),
                    loadNotifications()
                ]);

                // Setup auto-refresh
                setupAutoRefresh();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
            }
        }

        // Render User Info
        function renderUserInfo(user) {
            console.log('User data:', user); // Debug log
            document.getElementById('userName').textContent = user.full_name || 'User';
            document.getElementById('userEmail').textContent = user.email;

            // Check if avatar_url exists and is not empty
            if (user.avatar_url && user.avatar_url.trim() !== '') {
                console.log('Loading avatar:', user.avatar_url); // Debug log
                const avatarImg = document.getElementById('userAvatar');
                avatarImg.src = user.avatar_url;
                avatarImg.style.display = 'block';
                document.getElementById('userAvatarFallback').style.display = 'none';

                // Handle image load error
                avatarImg.onerror = function() {
                    console.error('Failed to load avatar image');
                    this.style.display = 'none';
                    document.getElementById('userAvatarFallback').style.display = 'flex';
                };
            } else {
                console.log('No avatar URL, showing initials'); // Debug log
                const initials = (user.full_name || user.email)
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                document.getElementById('userAvatarFallback').textContent = initials;
            }
        }

        // Load Stats
        async function loadStats() {
            try {
                const stats = await api.getUserStats();
                const statsGrid = document.getElementById('statsGrid');

                statsGrid.innerHTML = `
                    <div class="card">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span class="material-icons-round" style="font-size: 40px; color: var(--accent-primary);">science</span>
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);">${stats.labs_launched || 0}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">Labs Launched</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span class="material-icons-round" style="font-size: 40px; color: var(--success);">dns</span>
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);">${stats.services_launched || 0}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">Services Started</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                            <span class="material-icons-round" style="font-size: 40px; color: var(--warning);">access_time</span>
                            <div>
                                <div style="font-size: 28px; font-weight: 600; color: var(--text-primary);">${Math.round(stats.total_runtime_minutes || 0)}</div>
                                <div style="font-size: 14px; color: var(--text-secondary);">Total Minutes</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Load Lab Status
        async function loadLabStatus() {
            try {
                const labStatus = await api.getLabStatus();
                const section = document.getElementById('runningLabsSection');
                const grid = document.getElementById('runningLabsGrid');

                if (!labStatus || labStatus.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                grid.innerHTML = labStatus.map(lab => `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <span class="material-icons-round" style="font-size: 40px; color: var(--success);">terminal</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 500;">${lab.lab_name}</h3>
                                    <p style="margin: 4px 0 0; font-size: 12px; color: var(--text-secondary);">
                                        Port: ${lab.port} ${lab.volume ? '• Volume: ' + lab.volume : ''}
                                    </p>
                                </div>
                            </div>
                            <span class="badge badge-success">Running</span>
                        </div>

                        ${lab.access_url ? `
                        <div style="background: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--radius-sm); font-family: monospace; font-size: 12px; margin-bottom: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                            <code>${lab.access_url}</code>
                            <button class="btn btn-ghost btn-icon" style="width: 24px; height: 24px;" onclick="copyToClipboard('${lab.access_url}')" title="Copy URL">
                                <span class="material-icons-round" style="font-size: 16px;">content_copy</span>
                            </button>
                        </div>
                        ` : ''}

                        ${lab.resources ? `
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                            <span class="material-icons-round" style="font-size: 14px; vertical-align: middle;">memory</span>
                            CPU: ${lab.resources.cpus} cores • RAM: ${lab.resources.memory}
                        </div>
                        ` : ''}

                        <div style="display: flex; gap: var(--spacing-sm);">
                            ${lab.access_type === 'web_terminal' || lab.access_type === 'web' ? `
                            <button class="btn btn-primary" style="flex: 1;" onclick="openLabTerminal('${lab.lab}', '${lab.access_url || 'http://localhost:' + lab.port}')">
                                <span class="material-icons-round" style="font-size: 18px;">open_in_new</span>
                                Open Terminal
                            </button>
                            ` : `
                            <div style="background: var(--bg-tertiary); padding: var(--spacing-sm); border-radius: var(--radius-sm); font-family: monospace; font-size: 12px; flex: 1;">
                                <code>ssh student@127.0.0.1 -p ${lab.port}</code>
                            </div>
                            `}
                            <button class="btn btn-secondary" onclick="stopLab('${lab.lab}')">
                                <span class="material-icons-round" style="font-size: 18px;">stop</span>
                                Stop
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load lab status:', error);
            }
        }

        // Load Lab Catalog
        async function loadLabCatalog() {
            try {
                const catalog = await api.getLabs();
                const grid = document.getElementById('catalogGrid');

                grid.innerHTML = catalog.map(lab => {
                    const icons = {
                        'ubuntu-ssh': 'terminal',
                        'kali-linux': 'security',
                        'n8n': 'hub'
                    };

                    return `
                        <div class="card">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-md);">
                                <span class="material-icons-round" style="font-size: 40px; color: var(--accent-primary);">${icons[lab.id] || 'dns'}</span>
                                <div style="flex: 1;">
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 500;">${lab.name}</h3>
                                    <p style="margin: 4px 0 0; font-size: 14px; color: var(--text-secondary);">${lab.description}</p>
                                </div>
                            </div>

                            <div style="display: flex; gap: var(--spacing-sm);">
                                <button class="btn btn-primary" style="flex: 1;" onclick="startLab('${lab.id}')">
                                    <span class="material-icons-round" style="font-size: 18px;">rocket_launch</span>
                                    Launch
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load lab catalog:', error);
            }
        }

        // Load Service Status
        async function loadServiceStatus() {
            try {
                const serviceStatus = await api.getServiceStatus();
                const section = document.getElementById('runningServicesSection');
                const grid = document.getElementById('runningServicesGrid');

                if (!serviceStatus || serviceStatus.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                grid.innerHTML = serviceStatus.slice(0, 3).map(service => `
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
                            <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                                <span class="material-icons-round" style="font-size: 40px; color: var(--success);">dns</span>
                                <div>
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 500;">${service.service_name}</h3>
                                    <p style="margin: 4px 0 0; font-size: 12px; color: var(--text-secondary);">Port: ${service.port}</p>
                                </div>
                            </div>
                            <span class="badge badge-success">Running</span>
                        </div>
                        <a href="/ui/services.html" class="btn btn-secondary" style="width: 100%; text-decoration: none;">
                            View Credentials
                        </a>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load service status:', error);
            }
        }

        // Load Notifications
        async function loadNotifications() {
            try {
                const unreadCount = await api.getUnreadCount();
                const badge = document.getElementById('notificationBadge');

                if (unreadCount.count > 0) {
                    badge.textContent = unreadCount.count > 9 ? '9+' : unreadCount.count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load notification count:', error);
            }
        }

        // Toggle Notifications Dropdown
        async function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            notificationsOpen = !notificationsOpen;

            if (notificationsOpen) {
                dropdown.style.display = 'block';
                await loadNotificationsList();
            } else {
                dropdown.style.display = 'none';
            }
        }

        // Load Notifications List
        async function loadNotificationsList() {
            try {
                const notifications = await api.getNotifications(false);
                const list = document.getElementById('notificationsList');

                if (notifications.length === 0) {
                    list.innerHTML = '<div style="padding: var(--spacing-lg); text-align: center; color: var(--text-secondary);">No notifications</div>';
                    return;
                }

                list.innerHTML = notifications.map(notif => `
                    <div class="dropdown-item" style="background: ${notif.read ? 'transparent' : 'var(--accent-light)'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-xs);">
                            <strong style="font-size: 14px;">${notif.title}</strong>
                            ${!notif.read ? '<span class="badge badge-error" style="font-size: 10px;">New</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: var(--spacing-xs);">${notif.message}</div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">${new Date(notif.created_at).toLocaleString()}</div>
                        ${!notif.read ? `<button class="btn btn-ghost" style="margin-top: var(--spacing-xs); padding: 4px 8px; font-size: 12px;" onclick="markNotificationRead('${notif._id}')">Mark as read</button>` : ''}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }

        // Mark Notification as Read
        async function markNotificationRead(notificationId) {
            try {
                await api.markNotificationRead(notificationId);
                await loadNotifications();
                await loadNotificationsList();
            } catch (error) {
                console.error('Failed to mark notification as read:', error);
            }
        }

        // Mark All Notifications as Read
        async function markAllRead() {
            try {
                await api.markAllNotificationsRead();
                await loadNotifications();
                await loadNotificationsList();
            } catch (error) {
                console.error('Failed to mark all as read:', error);
            }
        }

        // Lab Actions
        async function startLab(labId) {
            try {
                const btn = event.target.closest('button');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons-round" style="font-size: 18px;">hourglass_empty</span> Starting...';

                await api.startLab(labId);
                await loadLabStatus();
                await loadStats();
            } catch (error) {
                alert('Failed to start lab: ' + (error.message || 'Unknown error'));
            }
        }

        async function stopLab(labId) {
            try {
                console.log('Stopping lab:', labId); // Debug log
                const btn = event.target.closest('button');
                btn.disabled = true;
                btn.innerHTML = '<span class="material-icons-round" style="font-size: 18px;">hourglass_empty</span> Stopping...';

                const result = await api.stopLab(labId);
                console.log('Stop lab result:', result); // Debug log

                await loadLabStatus();
                await loadStats();
            } catch (error) {
                console.error('Stop lab error:', error); // Debug log
                alert('Failed to stop lab: ' + (error.message || 'Unknown error'));
                // Re-enable button on error
                const btn = event.target.closest('button');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-icons-round" style="font-size: 18px;">stop</span> Stop';
                }
            }
        }

        // Open Lab Terminal in New Window
        function openLabTerminal(labId, accessUrl) {
            // Open lab terminal in new window with appropriate size
            const width = 1200;
            const height = 800;
            const left = (window.screen.width - width) / 2;
            const top = (window.screen.height - height) / 2;

            window.open(
                accessUrl,
                `lab_${labId}`,
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
            );
        }

        // Utilities
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show a toast notification here
                console.log('Copied to clipboard');
            });
        }

        // Setup Auto-Refresh
        function setupAutoRefresh() {
            // Refresh lab and service status every 5 seconds
            setInterval(async () => {
                await Promise.all([
                    loadLabStatus(),
                    loadServiceStatus(),
                    loadNotifications()
                ]);
            }, 5000);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const notifBtn = document.getElementById('notificationBtn');
            const notifDropdown = document.getElementById('notificationsDropdown');

            if (notificationsOpen && !notifBtn.contains(e.target) && !notifDropdown.contains(e.target)) {
                toggleNotifications();
            }
        });

        // Initialize on page load
        initDashboard();
    </script>
</body>
</html>
