<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Selfmade Labs – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #020617, #000);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 32px;
    }

    h1 { margin-bottom: 20px; }

    .top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logout {
      background: #1f2937;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
    }

    .card {
      max-width: 480px;
      background: rgba(2, 6, 23, 0.9);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 20px;
    }

    .status { margin-bottom: 6px; }
    .port { font-size: 0.85rem; color: #9ca3af; margin-bottom: 16px; }

    button {
      border-radius: 999px;
      padding: 10px 18px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .start { background: #22c55e; }
    .stop { background: #ef4444; margin-left: 8px; }
  </style>
</head>

<body>

  <div class="top">
    <h1>Selfmade Labs</h1>
    <div class="logout" onclick="logout()">Logout</div>
  </div>

  <div class="card">
    <div id="status" class="status">Loading…</div>
    <div id="port" class="port"></div>

    <button class="start" onclick="startLab()">Start Lab</button>
    <button class="stop" onclick="stopLab()">Stop Lab</button>
  </div>

<script>
  const token = localStorage.getItem("token");

  if (!token) location.href = "/ui/login.html";

  const statusEl = document.getElementById("status");
  const portEl = document.getElementById("port");

  function authHeaders() {
    return { "Authorization": "Bearer " + token };
  }

  async function fetchStatus() {
    const res = await fetch("/lab-status", { headers: authHeaders() });
    if (!res.ok) throw new Error("API error");
    return res.json();
  }

  async function refreshStatus() {
    try {
      const data = await fetchStatus();

      // --- PURE UI LOGIC ONLY ---
      if (data && data.running === true) {
        statusEl.innerText = "Lab running ✅";
        portEl.innerHTML = data.port
          ? `SSH: <code>ssh student@127.0.0.1 -p ${data.port}</code>`
          : "";
      } else {
        statusEl.innerText = "No lab running";
        portEl.innerHTML = "";
      }

    } catch (e) {
      console.error("Dashboard error:", e);
      statusEl.innerText = "Unable to fetch lab status";
      portEl.innerHTML = "";
    }
  }

  async function startLab() {
    await fetch("/start-lab", { method: "POST", headers: authHeaders() });
    setTimeout(refreshStatus, 500);
  }

  async function stopLab() {
    await fetch("/stop-lab", { method: "POST", headers: authHeaders() });
    setTimeout(refreshStatus, 500);
  }

  function logout() {
    localStorage.removeItem("token");
    location.href = "/ui/login.html";
  }

  refreshStatus();
  setInterval(refreshStatus, 5000);
</script>

</body>
</html>
