<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Selfmade Labs – Dashboard</title>
  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      padding: 40px;
    }
    .top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .start { background: #22c55e; color: #022c22; }
    .stop { background: #ef4444; color: #fff; }
    .logout { background: #1f2937; color: #e5e7eb; }
    .card {
      background: #020617;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #1f2937;
      max-width: 420px;
    }
    .status { margin-bottom: 8px; }
    code { background: #020617; padding: 4px 6px; border-radius: 6px; }
  </style>
</head>
<body>

<div class="top">
  <h2>Selfmade Labs</h2>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="card">
  <div class="status" id="status">Checking status…</div>
  <div id="port"></div>

  <br/>
  <button class="start" onclick="startLab()">Start Lab</button>
  <button class="stop" onclick="stopLab()">Stop Lab</button>
</div>

<script>
  
  const token = localStorage.getItem("token");

  if (!token) {
    window.location.href = "login.html";
  }

  function authHeaders() {
  return {
    "Authorization": "Bearer " + token,
    "Content-Type": "application/json"
  };
}


  async function refreshStatus() {
  const statusEl = document.getElementById("status");
  const portEl = document.getElementById("port");

  try {
    const res = await fetch("/lab-status", {
      headers: authHeaders()
    });

    // Auth error ONLY
    if (res.status === 401 || res.status === 403) {
      statusEl.innerText = "Session expired";
      localStorage.removeItem("token");
      return;
    }

    // Backend reachable but returned something unexpected
    if (!res.ok) {
      statusEl.innerText = "Server error";
      return;
    }

    const data = await res.json();

    // ✅ Normal case: no lab
    if (!data || data.running === false) {
      statusEl.innerText = "No lab running";
      portEl.innerHTML = "";
      return;
    }

    // ✅ Lab running
    statusEl.innerText = "Lab running ✅";
    portEl.innerHTML =
      `SSH: <code>ssh student@127.0.0.1 -p ${data.port}</code>`;

  } catch (err) {
    console.error("Fetch error:", err);
    statusEl.innerText = "Backend unreachable";
  }
}


  async function startLab() {
  try {
    await fetch("/start-lab", {
      method: "POST",
      headers: authHeaders()
    });
    refreshStatus();
  } catch (e) {
    console.error(e);
  }
}

async function stopLab() {
  try {
    await fetch("/stop-lab", {
      method: "POST",
      headers: authHeaders()
    });
    refreshStatus();
  } catch (e) {
    console.error(e);
  }
}


  function logout() {
    localStorage.removeItem("token");
    window.location.href = "login.html";
  }

  refreshStatus();
  setInterval(refreshStatus, 5000);
</script>

</body>
</html>
